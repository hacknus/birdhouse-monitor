<!DOCTYPE html>
<html lang="en">
<head>
    <title>V√∂geli</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'img/logo.png' %}">
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}" media="screen">
    <link rel="stylesheet" type="text/css" href="{% static 'css/print.css' %}" media="print">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function createPreview() {
            img = document.createElement("IMG");
            img.className += "mx-auto d-block rounded cam-stream";    // Zobraz IMG ako block a centruj na stred stranky
            img.src = "{% url 'video_feed' %}";
            return img;
        }

        $(document).ready(function () {
            enablePreview = document.getElementById("enablePreview");
            if (enablePreview.checked) {
                imgPreview.appendChild(
                    createPreview()
                );
            }
        });

        function togglePreviewLabel() {
            var checkbox = document.getElementById("enablePreview");
            var label = document.querySelector("label[for='enablePreview']");

            if (checkbox.checked) {
                label.textContent = "Disable preview";
            } else {
                label.textContent = "Enable preview";
            }
        }

        function showStream(e) {
            enablePreview = e.target;
            imgPreview = document.getElementById("imgPreview");
            saveImageBtn = document.getElementById("saveImageBtn");
            toggleIRButton = document.getElementById("toggleIRButton");

            if (enablePreview.checked) {
                imgPreview.appendChild(createPreview());
                saveImageBtn.disabled = false;  // Enable button
                toggleIRButton.disabled = false;  // Enable the IR button

            } else {
                imgPreview.innerHTML = "";  // Clear preview
                saveImageBtn.disabled = true;  // Disable button
                toggleIRButton.disabled = true;  // Disable the IR button

            }

            // Also update the label text
            togglePreviewLabel();
        }

        // Ensure the label updates and the stream shows when toggling
        document.getElementById("enablePreview").addEventListener("change", showStream);

        // Function to get CSRF token from the meta tag
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // JavaScript function to toggle the IR LED and update the button label
        function toggleIRLED() {
            const button = document.getElementById("toggleIRButton");
            const action = button.textContent === "IR OFF" ? "on" : "off"; // Determine if action is "on" or "off"

            // Send the request to toggle the IR LED
            fetch("/trigger_ir_led/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(), // Get the CSRF token from the meta tag
                    "Content-Type": "application/json"  // Ensure the content type is application/json
                },
                body: JSON.stringify({action: action})  // Send the action ("on" or "off")
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the button text depending on the action
                        button.textContent = action === "on" ? "IR ON" : "IR OFF";
                    } else {
                        console.error("Error toggling IR LED:", data.message);
                    }
                })
                .catch(error => console.error("Error:", error));
        }

    </script>
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>

<body>
<div class="container-fluid print-header">
    <img class="rounded" src="{% static 'img/logo.png' %}" alt="logo" width="64" height="48">
    <div class="print-divider"></div>
</div>

<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="collapsibleNavbar">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'index' %}">
                        <img class="rounded nav-icon" src="{% static 'img/home.png' %}" alt="Home" width="32"
                             height="32">
                        Home
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'gallery' %}">
                        <img class="rounded nav-icon" src="{% static 'img/gallery.png' %}" alt="Gallery" width="32"
                             height="32">
                        Gallery
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#about">
                        <img class="rounded nav-icon" src="{% static 'img/about.png' %}" alt="About" width="32"
                             height="32">
                        About
                    </a>
                </li>
            </ul>
        </div>
        <h3 class="text-center mt-3"><b>üê£</b></h3>
    </div>
</nav>

<div class="container mt-3 mb-4">
    <!-- Uvodna sprava -->
    <div class="row text-center">
        <p>Hoi V√∂geli.</p>
    </div>

    <!-- Zobrazenie streamu z kamery -->
    <div class="row row-border">
        <h3 class="text-center mt-3"><b>Camera stream</b></h3>
        <div class="text-center mt-1 mb-3">
            <div class="d-flex justify-content-center">
                <!-- Enable Preview Checkbox -->
                <input type="checkbox" class="btn-check" id="enablePreview" aria-describedby="enablePreviewHelp"
                       onchange="showStream(event)">
                <label class="btn btn-outline-dark me-2" for="enablePreview">Enable preview</label>

                <!-- Button to toggle IR LED (Initially Disabled) -->
                <button id="toggleIRButton" class="btn btn-primary" onclick="toggleIRLED()" disabled>IR OFF</button>
            </div>
            <div id="enablePreviewHelp" class="form-text">Please click above to tune into the live stream.</div>
        </div>
        <div class="mt-1 mb-2" id="imgPreview"></div>
        <!-- Save Image Button -->
        <div class="text-center mt-3">
            <button class="btn btn-success" id="saveImageBtn" disabled>Save Image</button>
            <p id="saveMessage" class="text-success mt-2"></p>
        </div>
    </div>

    <div class="container mt-3 mb-4">
        <!-- Display Temperature and Humidity -->
        <div class="row">
            <div class="col-md-6">
                <h3>Temperature</h3>
                <p id="temperature">Loading...</p>
            </div>
            <div class="col-md-6">
                <h3>Humidity</h3>
                <p id="humidity">Loading...</p>
            </div>
        </div>

        <!-- Display Motion Status -->
        <div class="row">
            <div class="col-md-12">
                <h3>Motion Status</h3>
                <p id="motionStatus">Loading...</p>
            </div>
        </div>

        <!-- Temperature and Humidity Graph -->
        <div class="row">
            <div class="col-md-6">
                <h3>Temperature Graph</h3>
                <canvas id="temperatureChart"></canvas>
            </div>
            <div class="col-md-6">
                <h3>Humidity Graph</h3>
                <canvas id="humidityChart"></canvas>
            </div>
        </div>
    </div>

</div>

<footer class="bg-dark text-center text-white" id="about">
    <div class="container p-4">
        <h5>Social media</h5>
        <section class="mb-4">
            <a class="btn btn-outline-light btn-floating m-1" href="https://github.com/hacknus/birdhouse-monitor"
               role="button">
                <i class="fa fa-github"></i>
            </a>
        </section>
        <h5>About us</h5>
        <section class="mb-4">
            V√∂geli üê£ is an open-source project that uses a Raspberry Pi to monitor your birdhouse. The codebase is
            inspired by <a href="https://github.com/markub3327/AIGarden" target="_blank" rel="noopener noreferrer">AIGarden</a>
            (Martin Kubovƒç√≠k).
        </section>
    </div>
    <div class="text-center p-3 my-footer">
        ¬© 2025 Copyright: Linus Leo St√∂ckli
    </div>
</footer>
<script>
    // Function to fetch temperature, humidity, and motion status
    function fetchData() {
        // Fetch temperature
        fetch("/get_temperature/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("temperature").textContent = data.temperature + " ¬∞C";
                updateTemperatureGraph(data.temperature);
            });

        // Fetch humidity
        fetch("/get_humidity/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("humidity").textContent = data.humidity + " %";
                updateHumidityGraph(data.humidity);
            });

        // Fetch motion status
        fetch("/get_motion_status/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("motionStatus").textContent = data.motion_triggered ? "Motion detected" : "No motion";
            });
    }

    // Set up the graph for temperature
    let temperatureChart = new Chart(document.getElementById("temperatureChart"), {
        type: "line",
        data: {
            labels: [],  // Time labels, will be filled dynamically
            datasets: [{
                label: 'Temperature (¬∞C)',
                data: [],  // Temperature data, will be filled dynamically
                borderColor: 'rgb(75, 192, 192)',
                fill: false
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // Set up the graph for humidity
    let humidityChart = new Chart(document.getElementById("humidityChart"), {
        type: "line",
        data: {
            labels: [],  // Time labels, will be filled dynamically
            datasets: [{
                label: 'Humidity (%)',
                data: [],  // Humidity data, will be filled dynamically
                borderColor: 'rgb(153, 102, 255)',
                fill: false
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });

    // Function to update the temperature graph
    function updateTemperatureGraph(temp) {
        let now = new Date().toLocaleTimeString();
        temperatureChart.data.labels.push(now);
        temperatureChart.data.datasets[0].data.push(temp);
        if (temperatureChart.data.labels.length > 10) {
            temperatureChart.data.labels.shift();
            temperatureChart.data.datasets[0].data.shift();
        }
        temperatureChart.update();
    }

    // Function to update the humidity graph
    function updateHumidityGraph(humidity) {
        let now = new Date().toLocaleTimeString();
        humidityChart.data.labels.push(now);
        humidityChart.data.datasets[0].data.push(humidity);
        if (humidityChart.data.labels.length > 10) {
            humidityChart.data.labels.shift();
            humidityChart.data.datasets[0].data.shift();
        }
        humidityChart.update();
    }

    // Initial fetch of data
    fetchData();
    setInterval(fetchData, 10000);  // Refresh every 10 seconds

    document.getElementById("saveImageBtn").addEventListener("click", function () {
        let imgPreview = document.getElementById("imgPreview");
        let enablePreview = document.getElementById("enablePreview");

        if (!enablePreview.checked || imgPreview.children.length === 0) {
            document.getElementById("saveMessage").innerText = "‚ö†Ô∏è Please enable the preview first!";
            return;
        }

        fetch("/save_image/", {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"}
        })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById("saveMessage").innerText = "‚úÖ Image saved to gallery!";
                } else {
                    document.getElementById("saveMessage").innerText = "‚ùå Error saving image.";
                }
            })
            .catch(error => console.error("Error:", error));
    });
</script>
</body>
</html>
